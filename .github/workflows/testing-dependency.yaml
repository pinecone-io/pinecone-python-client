name: Dependency Testing

on:
  workflow_call: {}

env:
  DD_CIVISIBILITY_AGENTLESS_ENABLED: true
  DD_API_KEY: ${{ secrets.DATADOG_API_KEY }}
  DD_SITE: datadoghq.com
  DD_ENV: ci
  DD_SERVICE: pinecone-python-client

jobs:
  dependency-matrix-setup:
    name: Deps setup
    runs-on: ubuntu-latest
    outputs:
      index_name: ${{ steps.setup-index.outputs.index_name }}
    steps:
      - uses: actions/checkout@v4
      - name: Create index
        id: setup-index
        uses: ./.github/actions/create-index
        timeout-minutes: 5
        with:
          name_prefix: depstest-${{ github.run_number }}
          dimension: 2
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}

  dependency-matrix-grpc:
    name: Deps (GRPC)
    needs: dependency-matrix-setup
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 10
      fail-fast: false
      matrix:
        python_version:
          - "3.11"
        grpcio_version:
          - 1.70.0
        lz4_version:
          - 4.4.3
        protobuf_version:
          - 5.29.3
        protoc-gen-openapiv2:
          - 0.0.1
        googleapis_common_protos_version:
          - 1.66.0
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/test-dependency-grpc
        with:
          python_version: '${{ matrix.python_version }}'
          index_name: '${{ needs.dependency-matrix-setup.outputs.index_name }}'
          PINECONE_API_KEY: '${{ secrets.PINECONE_API_KEY }}'
          grpcio_version: '${{ matrix.grpcio_version }}'
          lz4_version: '${{ matrix.lz4_version }}'
          protobuf_version: '${{ matrix.protobuf_version }}'
          googleapis_common_protos_version: '${{ matrix.googleapis_common_protos_version }}'
          DD_TAGS: 'test.configuration.python:${{ matrix.python_version}},test.configuration.grpcio:${{ matrix.grpcio_version }},test.configuration.lz4:${{ matrix.lz4_version }},test.configuration.protobuf:${{ matrix.protobuf_version }},test.configuration.googleapis_common_protos:${{ matrix.googleapis_common_protos_version }}'

  deps-cleanup:
    name: Deps cleanup
    runs-on: ubuntu-latest
    needs:
      - dependency-matrix-setup
      - dependency-matrix-grpc
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/delete-index
        with:
          index_name: '${{ needs.dependency-matrix-setup.outputs.index_name }}'
          PINECONE_API_KEY: '${{ secrets.PINECONE_API_KEY }}'
